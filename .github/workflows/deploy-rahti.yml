name: Deploy to Rahti

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install OpenShift CLI
        run: |
          wget https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
          tar -xvf openshift-client-linux.tar.gz
          sudo mv oc /usr/local/bin/

      - name: Login to OpenShift
        run: |
          oc login --token=${{ secrets.OPENSHIFT_TOKEN }} --server=https://api.2.rahti.csc.fi:6443

      - name: Select project
        run: |
          oc project ${{ secrets.OPENSHIFT_PROJECT }}

      - name: Trigger backend build
        run: |
          oc start-build report-backend -n ${{ secrets.OPENSHIFT_PROJECT }} --follow

      - name: Trigger frontend build
        run: |
          oc start-build report-frontend -n ${{ secrets.OPENSHIFT_PROJECT }} --follow

      - name: Wait for deployments to rollout
        run: |
          oc rollout status deployment/report-backend -n ${{ secrets.OPENSHIFT_PROJECT }}
          oc rollout status deployment/report-frontend -n ${{ secrets.OPENSHIFT_PROJECT }}

      - name: Get application URL
        run: |
          echo "Application deployed successfully!"
          oc get route report-writing -n ${{ secrets.OPENSHIFT_PROJECT }} -o jsonpath='{.spec.host}' | xargs -I {} echo "URL: https://{}"
